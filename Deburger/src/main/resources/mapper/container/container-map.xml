<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.deburger.app.office.container.mapper.ContainerMapper">
	
	<!-- 전체 조회 -->
	<select id="selectAllList" resultType="ContainerVO">
			select distinct
		        a.logistics_id,
		        a.logistics_name,
		        a.person_id,
		        b.stock_number,
		        b.stock_count,
		        b.material_number,
		        c.material_name,
		        c.material_classification,
		        c.logistics_safety_stock,
		        d.person_id,
		        e.inspection_operation,
		        e.material_number,
		        sum(e.in_count) as inCount,
		        sum(e.out_count) as outCount     
			from logistics a
			join logistics_stock b
			    on a.logistics_id = b.logistics_id
			join material c
			    on b.material_number = c.material_number
			join logistics_order_details d
			    on c.material_number = d.material_number
			join logistics_in e
			    on d.details_order_number = e.details_order_number
			group by a.logistics_id,
			        a.logistics_name,
			        a.person_id,
			        b.stock_number,
			        b.stock_count,
			        b.material_number,
			        c.material_name,
			        c.material_classification,
			        c.logistics_safety_stock,
			        d.person_id,
			        e.inspection_operation,
			        e.material_number    
			order by b.stock_number
	</select>
	
	<!-- 상세 조회 -->
	<select id="selectContainerInfo" resultType="ContainerVO">
			select distinct
			         a.details_order_number,
			         a.count,
			         a.supplier,
			         a.order_condition,
                     a.in_operation,
                     a.person_id,
			         b.lot,
			     	 b.in_day,
				     b.in_count,
				     b.expiration_limit,
				     c.material_number,
				     c.material_name,
			         d.logistics_id,
			         d.client_id
			from logistics_order_details a
			join logistics_in b
				on a.details_order_number = b.details_order_number
			join material c
				on a.material_number = c.material_number 
			join logistics_order d
				on a.order_number = d.order_number
			where c.material_number = #{materialNumber}
			and b.disposal_operation = 'N' 
			order by b.expiration_limit
	</select>
	
		<!-- 입고 조회 -->
	<select id="selectAllInList" resultType="ContainerVO">
			select a.lot,
			    a.in_day,
				a.in_count,
				a.inspection_operation,
				a.person_id,
				b.details_order_number,
				b.count,
				b.order_condition,
			    c.material_name,
			    d.order_day,
			    e.logistics_name,
			    f.client_id,
			    g.client_name
			from logistics_in a
			join logistics_order_details b
				on a.details_order_number = b.details_order_number
			join material c
				on b.material_number = c.material_number
			join logistics_order d
			on b.order_number = d.order_number
			join logistics e
				on d.logistics_id = e.logistics_id
			join company_material f 
			    on c.material_number = f.material_number 
			join supplier g
			    on f.client_id = g.client_id
	</select>
	
	<!-- 입고 처리 조회 -->
	<select id="selectInInfoList" resultType="ContainerVO" parameterType="list">
		select a.details_order_number,
		        a.count,
		        a.unit,
		        a.order_cost,
		        b.order_number,
		        c.logistics_name,
		        c.phone as logisticsPhone,
		        d.material_name,
		        e.material_number,
		        f.client_id,
		        f.client_name
		from  logistics_order_details a
		join logistics_order b
		        on a.order_number = b.order_number
		join logistics c
		        on b.logistics_id = c.logistics_id
		join material d
		        on a.material_number = d.material_number
		join company_material e
		         on d.material_number = e.material_number
		join supplier f
		       on e.client_id = f.client_id
		where a.details_order_number in 
    	<foreach item="obj" index="index" collection="list"
        	open="(" separator="," close=")">
			#{obj.detailsOrderNumber}
    	</foreach>
    	and f.client_id in
    	 <foreach item="obj" index="index" collection="list"
        	open="(" separator="," close=")">
			#{obj.clientId}
    	</foreach>
	</select>
	
	<!-- 물류 창고 폐기 조회 -->
	<select id="ContainerDeleteInfo" resultType="ContainerVO">
			select distinct
			         a.details_order_number,
			         a.count,
			         a.supplier,
			         a.order_condition,
                     a.in_operation,
                     a.person_id,
			         b.lot,
			     	 b.in_day,
				     b.in_count,
				     c.material_number,
				     c.material_name,
			         d.logistics_id,
			         d.client_id
			from logistics_order_details a
			join logistics_in b
				on a.details_order_number = b.details_order_number
			join material c
				on a.material_number = c.material_number 
			join logistics_order d
				on a.order_number = d.order_number
			where b.lot = #{lot}
	</select>
	
	<!-- 물류 창고 폐기 처리 -->
	<insert id="containerOutInsert" parameterType="ContainerVO">
		insert into logistics_out(
		    logistics_out_number,
		    out_date,
		    logistics_id,
		    out_count,
		    note,
		    out_operation,
		    lot
		)values(
		        'DV' || LPAD(DV_SEQ.nextval, '7', '0'),    
		        #{outDate},  
		        #{logisticsId},
		        #{outCount},
		        #{note},
		        #{outOperation},
		        #{lot}
		)
	</insert>
	
	<update id="containerInupdate">
		update logistics_in
		set out_count = #{outCount},
			disposal_operation = #{disposalOperation}
		where lot = #{lot}
	</update>
	

</mapper>