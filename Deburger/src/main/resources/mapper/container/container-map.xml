<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.deburger.app.office.container.mapper.ContainerMapper">
	
	<!-- 전체 조회 -->
	<select id="selectAllList" resultType="ContainerVO">
			select distinct
		        a.logistics_id,
		        a.logistics_name,
		        a.person_id,
		        b.stock_number,
		        b.stock_count,
		        b.material_number,
		        c.material_name,
		        c.material_classification,
		        c.logistics_safety_stock,
		        d.person_id,
		        e.inspection_operation,
		        e.material_number,
		        sum(e.in_count) as inCount,
		        sum(e.out_count) as outCount     
			from logistics a
			join logistics_stock b
			    on a.logistics_id = b.logistics_id
			join material c
			    on b.material_number = c.material_number
			join logistics_order_details d
			    on c.material_number = d.material_number
			join logistics_in e
			    on d.details_order_number = e.details_order_number
			group by a.logistics_id,
			        a.logistics_name,
			        a.person_id,
			        b.stock_number,
			        b.stock_count,
			        b.material_number,
			        c.material_name,
			        c.material_classification,
			        c.logistics_safety_stock,
			        d.person_id,
			        e.inspection_operation,
			        e.material_number    
			order by b.stock_number
	</select>
	
	<!-- 상세 조회  			and b.disposal_operation = 'N' -->
	<select id="selectContainerInfo" resultType="ContainerVO">
			select distinct
			         a.details_order_number,
			         a.count,
			         a.supplier,
			         a.order_condition,
                     a.in_operation,
                     a.person_id,
			         b.lot,
			     	 b.in_day,
				     b.in_count,
				     b.expiration_limit,
				     c.material_number,
				     c.material_name,
			         d.logistics_id,
			         d.client_id
			from logistics_order_details a
			join logistics_in b
				on a.details_order_number = b.details_order_number
			join material c
				on a.material_number = c.material_number 
			join logistics_order d
				on a.order_number = d.order_number
			where c.material_number = #{materialNumber}
			order by b.expiration_limit
	</select>
	
		<!-- 입고 조회 -->
	<select id="selectAllInList" resultType="ContainerVO">
			select a.order_number,
			        a.note,
			        a.client_id,
			        b.order_condition,
			        b.person_id,
			        b.in_operation,
			        sum(b.count) as sum,
			        c.logistics_id,
			        d.client_name,
			        sum(e.in_count) as inCount
			from logistics_order a
			join logistics_order_details b
			        on a.order_number = b.order_number
			join logistics c
			        on a.logistics_id  = c.logistics_id
			join supplier d
			        on a.client_id = d.client_id
			join logistics_in e
			        on b.details_order_number = e.details_order_number
			where  c.logistics_id = 'CTN0000013'        
			group by a.order_number,
			        a.note,
			        a.client_id,
			        b.order_condition,
			        b.person_id,
			        b.in_operation,
			        c.logistics_id,
			        d.client_name
	</select>
	
	<!-- 입고 처리 조회 -->
	<select id="selectInInfoList" resultType="ContainerVO" parameterType="list">
		select a.details_order_number,
		        a.count,
		        a.unit,
		        a.order_cost,
		        a.person_id,
		        b.order_number,
		        c.logistics_name,
		        c.phone as logisticsPhone,
		        d.material_name,
		        e.material_number,
		        f.client_id,
		        f.client_name
		from  logistics_order_details a
		join logistics_order b
		        on a.order_number = b.order_number
		join logistics c
		        on b.logistics_id = c.logistics_id
		join material d
		        on a.material_number = d.material_number
		join company_material e
		         on d.material_number = e.material_number
		join supplier f
		       on e.client_id = f.client_id
		where b.order_number = #{orderNumber}
	</select>
	
	<!-- 입고 처리 -->
	<insert id="containerInInsert">
		 insert into logistics_in(
			        lot,
			        details_order_number,
			        in_day,
			        in_count,
			        expiration_limit,
			        consumption_limit,
			        manufacture_day,
			        inspection_operation,
			        person_id
		 )values(
		      'LOT' || LPAD(LOT_SEQ.nextval, '7', '0'), 
		      #{detailsOrderNumber},
		      #{inDay},
		      #{inCount},
	          #{expirationLimit},
	          #{consumptionLimit},
	          #{manufactureDay},
	          #{inspectionOperation},
	          #{personId}	           
		 )
	</insert>
	
	<update id="containerInDelete">
		
	</update>
	
	<update id="containerInUpdate">
		update logistics_order_details
 		set in_operation = #{inOperation}
 		where details_order_number = #{detailsOrderNumber}
	</update>
	
	
	<!-- 물류 창고 폐기 조회 -->
	<select id="ContainerDeleteInfo" resultType="ContainerVO">
			select distinct
			         a.details_order_number,
			         a.count,
			         a.supplier,
			         a.order_condition,
                     a.in_operation,
                     a.person_id,
			         b.lot,
			     	 b.in_day,
				     b.in_count,
				     c.material_number,
				     c.material_name,
			         d.logistics_id,
			         d.client_id
			from logistics_order_details a
			join logistics_in b
				on a.details_order_number = b.details_order_number
			join material c
				on a.material_number = c.material_number 
			join logistics_order d
				on a.order_number = d.order_number
			where b.lot = #{lot}
	</select>

	
	<!-- 물류 창고 폐기 처리 -->
	<insert id="containerOutInsert" parameterType="ContainerVO">
		insert into logistics_out(
		    logistics_out_number,
		    out_date,
		    logistics_id,
		    out_count,
		    note,
		    out_operation,
		    lot
		)values(
		        'DV' || LPAD(DV_SEQ.nextval, '7', '0'),    
		        #{outDate},  
		        #{logisticsId},
		        #{outCount},
		        #{note},
		        #{outOperation},
		        #{lot}
		)
	</insert>
	
	<update id="containerInupdate">
		update logistics_in
		set out_count = #{outCount},
			disposal_operation = #{disposalOperation}
		where lot = #{lot}
	</update>
	
	
	<!-- 물류창고 출고 리스트 -->
	<select id="containerOutList">
		select a.order_number,
		        sum(b.count) as count,
		        c.logistics_id,
		        c.store_name
		from store_order a
		join order_details b
		    on a.order_number = b.order_number
		join store c
		    on a.store_number = c.store_number
		group by a.order_number,
		        c.logistics_id,
		        c.store_name
		order by order_number
	</select>
	
	<!-- 출고 상세 조회-->
	<select id="containerOutListInfo">
		select a.order_details_number,
		        a.material_number,
		        a.order_number,
		        b.material_name
		from order_details a
		join material b
		    on a.material_number = b.material_number
		where a.order_number = #{orderNumber}
	
	</select>
	
	<select id="containerOutModal">
		select a.lot,
		       a.in_count,
			   a.in_day,
			   b.details_order_number,
			   c.material_number,
			   c.material_name
		from logistics_in a
			join logistics_order_details b
			on a.details_order_number = b.details_order_number
			join material c
			on b.material_number = c.material_number
		where c.material_number = #{materialNumber}		
	</select>

</mapper>